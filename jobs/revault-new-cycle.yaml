name: Prepare revault stg (next, qa, ppr2)

steps:
  - name: Clone sre-argocd repo
    id: clone_sre_argocd
    uses: actions/git-clone
    with:
      repo: LedgerHQ/sre-argocd
      fetch-depth: 1

  - name: Find revault deploy versions
    id: revault_deploy_versions
    uses: actions/revault-find-deploy-versions
    with:
      sre-argocd-dir: ${clone_sre_argocd.repo.local_dir}

  - name: Ensure precondition
    if: revault_deploy_versions.stg != revault_deploy_versions.ppr || revault_deploy_versions.stg != revault_deploy_versions.prd
    uses: actions/abort
    with:
      message: |
        Revault versions do not match:
        - stg : ${revault_deploy_versions.stg}
        - ppr : ${revault_deploy_versions.ppr}
        - prd : ${revault_deploy_versions.prd}

  - name: Create new revault value file
    id: revault_new_cycle
    run: |
      old_version="${revault_deploy_versions.stg}"
      major=${old_version%.*}
      minor=$(( ${old_version#*.} + 1 ))
      new_version="$major.$minor"
      echo "Copying version: $old_version => $new_version"
      cp "deploy/platform-2220-cluster/applications/vault/releases/revault-${old_version}.yaml" \
         "deploy/platform-2220-cluster/applications/vault/releases/revault-${new_version}.yaml"
      echo "old_version=$old_version" >> $OUTPUT
      echo "new_version=$new_version" >> $OUTPUT
    working-dir: ${clone_sre_argocd.repo.local_dir}

  - name: Update revault deploy versions
    id: update_revault_deploy_versions
    uses: actions/revault-update-deploy-versions
    with:
      sre-argocd-dir: ${clone_sre_argocd.repo.local_dir}
      target-env: stg
      from-version: ${revault_new_cycle.old_version}
      to-version: ${revault_new_cycle.new_version}

  - name: Commit and push to sre-argocd
    id: push_sre_argocd
    run: |
      if git diff --quiet && git diff --cached --quiet; then
        echo "No changes to commit in sre-argocd"
        exit 1
      fi
      sre_argocd_branch=chore-revault-stg-${revault_new_cycle.new_version}
      echo "Creating branch $sre_argocd_branch in sre-argocd..."
      git checkout -b $sre_argocd_branch
      git add -A
      git commit -m "chore: update revault stg to ${revault_new_cycle.new_version}"
      git push --set-upstream origin $sre_argocd_branch
      echo "sre_argocd_branch=$sre_argocd_branch" >> $OUTPUT
    working-dir: ${clone_sre_argocd.repo.local_dir}

  - name: Create a PR in sre-argocd
    uses: actions/github-create-pr
    if: push_sre_argocd.sre_argocd_branch != ""
    with:
      repo: LedgerHQ/sre-argocd
      head: ${push_sre_argocd.sre_argocd_branch}
      base: main
      title: "chore(revault): update revault stg to ${revault_new_cycle.new_version}"
