name: Deploy revault to stg

inputs:

env:

steps:
  - name: Clone revault repo
    id: clone_revault
    uses: actions/git-clone
    with:
      repo: LedgerHQ/revault
      fetch-depth: 1
  - name: Clone sre-argocd repo
    id: clone_sre_argocd
    uses: actions/git-clone
    with:
      repo: LedgerHQ/sre-argocd
      fetch-depth: 1
  - name: Patch argocd preset
    run: SRE_ARGOCD_REPO_PATH="${clone_sre_argocd.repo.local_dir}" pnpm patch-argocd-preset
    working-dir: ${clone_revault.repo.local_dir}
  - name: Commit and push to sre-argocd
    id: update_sre_argocd
    run: |
      if git diff --quiet && git diff --cached --quiet; then
        echo "No changes to commit in sre-argocd"
        exit 0
      fi
      sre_argocd_branch=chore-deploy-revault-to-stg
      echo "Creating branch $sre_argocd_branch in sre-argocd..."
      git checkout -b $sre_argocd_branch
      git add -A
      git commit -m "chore: update revault preset"
      git push --set-upstream origin $sre_argocd_branch
      echo "sre_argocd_branch=$sre_argocd_branch" >> $OUTPUT
    working-dir: ${clone_sre_argocd.repo.local_dir}
  - name: Create a PR in sre-argocd
    uses: actions/github-create-pr
    with:
      repo: LedgerHQ/sre-argocd
      head: ${update_sre_argocd.sre_argocd_branch}
      base: main
      title: "chore: update revault preset"
