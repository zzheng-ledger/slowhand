name: Prepare revault stg (next, qa, ppr2)

steps:
  - name: "revault: clone and checkout new branch"
    id: revault
    uses: actions/git-clone
    with:
      repo: LedgerHQ/revault
      fetch-depth: 1
      new-branch: chore-update-deps

  - name: Update dependencies
    run: pnpm update -r
    working-dir: ${revault.repo.local_dir}

  - name: Revert changes in mobile package
    uses: actions/revault-revert-mobile-deps
    with:
      revault-dir: ${revault.repo.local_dir}

  - name: Install and lock deps
    run: git restore pnpm-lock.yaml && pnpm install
    working-dir: ${revault.repo.local_dir}

  - name: Format and run static checks
    run: |
      # to make it faster, do not run `test`
      pnpm run format
      pnpm run lint
      pnpm run typecheck
      pnpm run spellcheck
      pnpm run depscheck
      pnpm run check-convention
    working-dir: ${revault.repo.local_dir}

  - name: Commit and push
    run: |
      if git diff --quiet && git diff --cached --quiet; then
        echo "No changes to commit"
        exit 1
      fi
      git add -A
      git commit -m "chore: update deps"
      git push --set-upstream origin ${revault.repo.new_branch}
    working-dir: ${revault.repo.local_dir}

  - name: Create PR
    uses: actions/github-create-pr
    with:
      repo: LedgerHQ/revault
      head: ${revault.repo.new_branch}
      base: main
      title: "chore: update deps"
