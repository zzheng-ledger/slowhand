name: Prepare revault stg (next, qa, ppr2)

steps:
  - name: "sre-argocd: clone and checkout new branch"
    id: sre_argocd_repo
    uses: actions/git-clone
    with:
      repo: LedgerHQ/sre-argocd
      fetch-depth: 1
      new-branch: chore-revault-new-cycle

  - name: Find revault deploy versions
    id: revault_deploy_versions
    uses: actions/revault-find-deploy-versions
    with:
      sre-argocd-dir: ${{ steps.sre_argocd_repo.outputs.repo_dir }}

  - name: Abort if precondition is not met
    if: revault_deploy_versions.stg != revault_deploy_versions.ppr || revault_deploy_versions.stg != revault_deploy_versions.prd
    uses: actions/abort
    with:
      message: |
        Revault versions do not match:
        - stg : ${{ steps.revault_deploy_versions.outputs.stg }}
        - ppr : ${{ steps.revault_deploy_versions.outputs.ppr }}
        - prd : ${{ steps.revault_deploy_versions.outputs.prd }}

  - name: Compute next version
    id: revault_next_version
    uses: actions/compute-version
    with:
      input: ${{ steps.revault_deploy_versions.outputs.stg }}
      add-minor: 1

  - name: Create new revault value file
    id: revault_new_cycle
    run: |
      releases_dir="deploy/platform-2220-cluster/applications/vault/releases"
      old_version="${{ steps.revault_deploy_versions.outputs.stg }}"
      new_version="${{ steps.revault_next_version.outputs.result }}"
      echo "Copying version: ${old_version} => ${new_version}"
      cp "${releases_dir}/revault-${old_version}.yaml" "${releases_dir}/revault-${new_version}.yaml"
      echo "old_version=${old_version}" >> $OUTPUT
      echo "new_version=${new_version}" >> $OUTPUT
    working-dir: ${{ steps.sre_argocd_repo.outputs.repo_dir }}

  - name: Update revault deploy versions
    id: update_revault_deploy_versions
    uses: actions/revault-update-deploy-versions
    with:
      sre-argocd-dir: ${{ steps.sre_argocd_repo.outputs.repo_dir }}
      target-env: stg
      from-version: ${{ steps.revault_new_cycle.outputs.old_version }}
      to-version: ${{ steps.revault_new_cycle.outputs.new_version }}

  - name: Commit and push
    uses: actions/git-commit-push-branch
    with:
      repo-dir: ${{ steps.sre_argocd_repo.outputs.repo_dir }}
      branch: ${{ steps.sre_argocd_repo.outputs.new_branch }}
      message: "chore(revault): start new release cycle (${{ steps.revault_new_cycle.outputs.new_version }})"

  - name: Create a PR in sre-argocd
    uses: actions/github-create-pr
    with:
      repo: LedgerHQ/sre-argocd
      head: ${{ steps.sre_argocd_repo.outputs.new_branch }}
      base: main
      title: "chore(revault): start new release cycle (${{ steps.revault_new_cycle.outputs.new_version }})"
