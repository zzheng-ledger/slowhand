name: Deploy revault from dev to stg (next, qa, ppr2)

steps:
  - name: "revault: clone"
    id: revault
    uses: actions/git-clone
    with:
      repo: LedgerHQ/revault
      fetch-depth: 1

  - name: "sre-argocd: clone and checkout new branch"
    id: sre_argocd
    uses: actions/git-clone
    with:
      repo: LedgerHQ/sre-argocd
      fetch-depth: 1
      new-branch: chore-deploy-revault-to-stg-${{ revault.repo.head_hash_short }}

  - name: Patch argocd preset
    run: SRE_ARGOCD_REPO_PATH="${{ sre_argocd.repo.local_dir }}" pnpm patch-argocd-preset
    working-dir: ${{ revault.repo.local_dir }}

  - name: Commit and push to sre-argocd
    id: update_sre_argocd
    run: |
      if git diff --quiet && git diff --cached --quiet; then
        echo "No changes to commit in sre-argocd"
        exit 1
      fi
      git add -A
      git commit -m "chore: update revault preset"
      git push --set-upstream origin ${{ sre_argocd.repo.new_branch }}
    working-dir: ${{ sre_argocd.repo.local_dir }}

  - name: Create a PR in sre-argocd
    uses: actions/github-create-pr
    with:
      repo: LedgerHQ/sre-argocd
      head: ${{ sre_argocd.repo.new_branch }}
      base: main
      title: "chore(revault): deploy revault to stg (${{ revault.repo.head_hash_short }})"
