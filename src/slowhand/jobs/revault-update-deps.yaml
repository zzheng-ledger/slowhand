name: Prepare revault stg (next, qa, ppr2)

inputs:
  pin:
    type: string
    description: comma-separated keyword(s) of libraries to pin
    required: false

steps:
  - name: "revault: clone and checkout new branch"
    id: revault_repo
    uses: actions/git-clone
    with:
      repo: LedgerHQ/revault
      fetch-depth: 1
      new-branch: chore-update-deps

  - name: Update dependencies
    run: pnpm update -r
    working-dir: ${{ steps.revault_repo.outputs.repo_dir }}

  - name: Revert upgrades of pinned libraries
    if: inputs.pin
    uses: actions/revault-revert-pinned-deps
    with:
      revault-dir: ${{ steps.revault_repo.outputs.repo_dir }}
      pin: ${{ inputs.pin }}

  - name: Revert changes in mobile package
    uses: actions/revault-revert-mobile-deps
    with:
      revault-dir: ${{ steps.revault_repo.outputs.repo_dir }}

  - name: Install and lock deps
    run: |
      git restore pnpm-lock.yaml
      find . -name "node_modules" -type d -prune -exec rm -rf '{}' +
      pnpm install
      pnpm dedupe
    working-dir: ${{ steps.revault_repo.outputs.repo_dir }}

  - name: Format and run static checks
    run: |
      find . -name ".eslintcache" -type f -delete
      # to make it faster, do not run `test`
      pnpm run format
      pnpm run lint
      pnpm run typecheck
      pnpm run spellcheck
      pnpm run depscheck
    working-dir: ${{ steps.revault_repo.outputs.repo_dir }}

  - name: Commit and push
    uses: actions/git-commit-push-branch
    with:
      repo-dir: ${{ steps.revault_repo.outputs.repo_dir }}
      branch: ${{ steps.revault_repo.outputs.new_branch }}
      message: "chore: update deps"

  - name: Create PR
    uses: actions/github-create-pr
    with:
      repo: LedgerHQ/revault
      head: ${{ steps.revault_repo.outputs.new_branch }}
      base: main
      title: "chore: update deps"
